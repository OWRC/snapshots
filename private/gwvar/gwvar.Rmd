---
title: "Water Level Variability and Trends"
author: "Oak Ridges Moraine Groundwater Program"
date: "`r gsub(' 0', ' ', format(Sys.time(), '%d %B, %Y'))`"
output:
  html_document:
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
subtitle: "Analysis of groundwater levels in south-central Ontario"
# always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(lubridate)
library(stringr)
library(mgcv)
library(ggplot2)
library(scales)
library(leaflet)
library(leaflet.extras)
library(metathis)


pkl.dir <- "pkl/"
examplfn <- "875144935.csv" # "890869235.csv" # -1021429775.csv" # 


exampldf <- read.csv(paste0(pkl.dir, examplfn)) %>%
  mutate(date=as.Date(Date)) %>%
  mutate(doy=yday(date), yr=year(date))


sdf <- read.csv("gwGAM-summary.R.csv") %>%
  drop_na(SCREEN_TOP_DEPTH_M)


# other stats
# nWel <- length(list.files(pkl.dir, ".pkl"))
nWel <- nrow(sdf[sdf$WL_AVG_TOTAL_NUM>34,])
nPkl <- length(list.files(pkl.dir, ".csv"))


sdf <- sdf %>% 
  drop_na(GAMrange) %>%
  mutate(isdeep=SCREEN_TOP_DEPTH_M>20)

cols <- c("#16557F", "#EE6C4D") # c("#16557F", "#A6CEE3")
```

```{r html-meta, echo=FALSE}
meta() %>%
  meta_description(
    "Variability of the water table in south-central Ontario."
  ) %>% 
  meta_social(
    title = "Water Level Variability and Trends",
    url = "https://owrc.github.io/snapshots/md/gwvar.html",
    image = "https://golang.oakridgeswater.ca/pages/gif/gwvar-sample.gif",
  )
```


<!-- <meta name="image" property="og:image" content="https://golang.oakridgeswater.ca/pages/gif/gwvar-sample.gif"> -->
<!-- <meta name="description" property="og:description" content="Variability of the water table in south-central Ontario."> -->


# Introduction



Groundwater levels are fundamental to the practice of hydrogeology. They are necessary for flow system analysis and understanding from determining hydraulic gradients to estimating material properties to calibrating regional groundwater flow models. 

From a hydrological perspective, groundwater levels and their seasonal fluctuation affect runoff generation in southern Ontario. Longer-term (5-10yr) fluctuations could also have impacts on land use development; think of constructing and maintaining buried infrastructure (e.g., sewers, water mains), or applying certain Low Impact Design (LID) strategies, etc.


For a number of good reasons, groundwater resource management frequently tends to boil down to a set of steady-state (static) targets. This immediately implies that the steady-state condition represents some long-term average state, without determining, say: *How much should I expect the water table to vary from its current position?*



### The ORMGP

The [Oak Ridges Moraine Groundwater Program](https://www.oakridgeswater.ca/) reflects the intent of fifteen government agencies (municipalities and conservation authorities) to jointly manage, synthesize and disseminate water resources data, analysis, knowledge, geologic interpretations, and numerical models over a 30,000 km² area situated in south-central Ontario. 

Interpretive ORMGP maps showing estimates of the depth to the water table and deeper potentiometric surfaces are gaining increased use. These maps are constructed from thousands of data points collected over many years and at various times of the year and are considered to represent an "average" state. To effectively use these maps, users must be aware of variability in the groundwater system and consider i) longer-term deviation from the measured and average conditions, ii) short-term seasonal patterns, and iii) water table sensitivity to storm and/or snow melt events. 

From the program's database, `r nWel` good-quality, active and inactive, monitoring wells exist within the study area, collecting regular (e.g., daily, hourly or less) datalogger groundwater level data over decades. At some locations, when evaluated alongside climate data (e.g., precipitation and snow melt estimates) the water level response to events or stresses can be analysed. An example location, Alton PS 3-1, is provided below.



```{r sample, echo=FALSE, message=FALSE, warning=FALSE}
source("ps-3-1/gwvar-AltonPS-3-1.R", local = TRUE)$value
```

*A 4.2m deep well located 120m away from Shaw's Creek, Alton, ON.*


<br>

### Longer-term levels

Long-term seasonal variability in shallow groundwater levels has been quantified using a 12-point Generalized Additive Model (GAM) that provides confidence intervals to a fitted seasonal trend. 

> From `r nrow(sdf[!sdf$isdeep,])` shallow wells (depths < 20m) analysed, the south-central Ontario water table fluctuates ±`r round(mean(sdf$GAMrange[!sdf$isdeep]),1)` (s.d. `r round(sd(sdf$GAMrange[!sdf$isdeep]),1)`) m relative to some "average" state. Deeper (>20m depth; n=`r nrow(sdf[sdf$isdeep,])`) wells show greater fluctuation of groundwater levels at ±`r round(mean(sdf$GAMrange[sdf$isdeep]),1)` (s.d. `r round(sd(sdf$GAMrange[sdf$isdeep]),1)`) m.






# Methodology


<!-- ## The Good, the Bad, the Ugly -->

<!-- ```{r model, echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- source("gwvar/func/gwGAM-sampler-0model.R", local = TRUE)$value -->
<!-- ``` -->

<!-- ### Long-term trend -->

<!-- ```{r good, echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- source("gwvar/func/gwGAM-sampler-1longterm.R", local = TRUE)$value -->
<!-- ``` -->

<!-- ### Seasonality -->

<!-- ```{r bad, echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- source("gwvar/func/gwGAM-sampler-2seasonal.R", local = TRUE)$value -->
<!-- ``` -->

<!-- ### Noise -->

<!-- ```{r ugly, echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- source("gwvar/func/gwGAM-sampler-3noise.R", local = TRUE)$value -->
<!-- ``` -->





## Pattern + Noise


The intention here is to determine the expected range of variability one should expect when interpreting the ORMGP interpolated water table/potentiometric surface maps. The [_**water table map**_](https://owrc.github.io/watertable/) should be thought of as a *long-term average* with uncertainty associated with _*when*_ the measurements were made. It is a surface interpolated from 100,000s of measurements made over the past century, and constrained by mapped watercourses, water bodies, subsurface sediment permeability, etc.

Realistically, the depth to water table and potentiometric surfaces can vary naturally by a metre or even more, especially where water levels are affected by local groundwater pumping centres. Long-term trends in water levels and aquifer storage can further impact expected water levels, as this changes the stage from which the expected variability is to occur. 

For now, lets skip the event-based groundwater response and break the expected variability into 2 components: 

$$\text{inter-annual variability} + \text{seasonal variability}$$

Further more, lets assert:

  - seasonal variability is assumed to have an annual cyclic nature; and
  - inter-annual variability (or long-term trend) can be used to de-trend the time-series.




## Generalized Additive Model

The Generalized Additive Model (GAM) is a flexible means of fitting a model to time series data. It is a generalization of the linear models we have all fit to a scatter plot while retaining the ability to efficiently compute confidence/prediction intervals using an intuitive control (Wood, 2017).

GAMs are especially useful as hydrographs contain a good deal of noisy auto-correlated data (that is, a sequence of measurements made in a short time frame tend to be correlated). For instance, it's apparent that there is a seasonal pattern to most hydrological data in southern Ontario. Here we design the GAM with 12 smoothing spline "knots", one for every calendar month. These monthly knots are further specified as being a cyclic regression spline by assuring that the surface remains continuous to the second derivative at a year's end (Wood, 2017). The GAM will fit a smoothing spline that captures the underlying seasonal pattern.

The same goes for the long-term trend, which is determined using knots specified to every year. The GAM is then specified as:

$$
  \texttt{h}_i = f_{yr}(\texttt{year}_i) + f_\tilde{m}(\texttt{day.of.year}_i) + e_i, \quad e_i=\phi e_{i-1}+\epsilon_i
$$

where $h_i$ is the expected/modelled water level, the "smooth function" $f_{yr}$ is the long-term trend and $f_\tilde{m}$ is the seasonal variability of the GAM, and $e_i$ is the AR(1) autocorrelation function. The GAM is initially set to having 365 + $n$ degrees of freedom, $n$ is the number of years.

What's important is that the above equation is linear, and so the GAM can be decomposed into long-term and seasonal patterns fitted to the data:



```{r quadrants.sample, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
  source("func/gwGAM-sampler-ALL.R", local = TRUE)$value
  df.exmpl <- read.csv(paste0("pkl/", examplfn)) %>%
    mutate(date=as.Date(Date)) %>%
    mutate(doy=yday(date), 
           year=year(date), 
           dcnt=as.numeric(date-min(date))
    )
  
  # GAMM
  # grouping by year to speed up corAR1
  cdf.exmpl <- gamm(data=df.exmpl, Val~s(doy,bs="cc",k=12)+s(year,bs="cr",k=length(unique(df$year))), correlation=corAR1(form=~1|year))
  preds.exmpl <- predict(cdf.exmpl$gam, type="terms", se.fit=TRUE)
  GAM.grid(df.exmpl,cdf.exmpl,preds.exmpl) 
```

*An example GAM analysis outputted for NVCA - Midhurst BH2 (PGMN W0000244-2).*

<br>



The above four plots illustrate an example of the output for a [PGMN](https://data.ontario.ca/dataset/provincial-groundwater-monitoring-network) groundwater level monitoring location (NVCA - Midhurst BH2). The bottom 2 plots illustrate the first 2 terms $\left(f_{yr}(\texttt{year}_i) \text{ and } f_\tilde{m}(\texttt{day.of.year}_i)\right)$ of the above equation, with 90% prediction intervals shaded. The top 2 plots show the GAM vs. observed both over the period of record (left) and after being de-trended (right).

The *y*-axis label of the bottom 2 plots report numbers called the "effective degrees of freedom," which relates to the minimum number of constraints needed to reproduce this GAM, simplifying the regression from the initial constraints given (i.e., $\text{e.d.f}=3.4+9.5 \ll 365+n$.)



### Processing steps

The ORMGP database currently hosts `r nWel` locations with >34 water level logger measurements having a well screen depth and at least 4 years of data. In addition, for every location time-series:

1. outliers were automatically removed using the ±1.5 IQR (inter-quartile range) method.
1. water level data were re-sampled to daily averages.
<!-- 1. monitoring locations with less than 34 records where removed -->
<!-- 1. monitoring locations with less than a 4 year period of record where removed -->
<!-- 1. monitoring locations without a reported depth where removed -->
1. values are factored according to their day-of-year and year of the reported groundwater level.
1. data are de-trended by subtracting $f_{yr}$ from the data.
1. 90% prediction intervals surrounding the GAM are added to the smooth function $f_\tilde{m}$.
1. annual maximum and minimum extent of the prediction intervals defines *the anticipated range in groundwater levels one should expect at a given location in the near future*. (This is given in the upper-right plot in the above figure.)

#### Outputs

- [Download GAM plots produced for all `r nWel` locations here](https://www.dropbox.com/scl/fi/uhl611zqhmqcb0ea925s5/gwGAM-summary.pdf?rlkey=71shw1gnl0tckjblwudw3atiy&dl=1).
- [Tabular form here](https://www.dropbox.com/scl/fi/973q2ts8qm7yo7a6dbjfc/gwGAM-summary.R.csv?rlkey=7uw31hllk1yixo7gh0dxksmzo&dl=1).



<br><hr><br>

# Maps

## Water Level Range

> hover over any circle to reveal station properties, click for more details. Full-screen available in the top-left corner


```{r funcGAMmap, include=FALSE}
  source("func/GAMmap.R", local = TRUE)$value
```

### Water Table 

GAM modelled seasonal groundwater level variability for shallow (<20m) wells.

<!-- <iframe src="https://golang.oakridgeswater.ca/pages/gwvar-map-leaflet-GAM-shallow.html" width="100%" height="400" scrolling="no" allowfullscreen></iframe> -->

```{r GAMshallow, echo=FALSE, message=FALSE, warning=FALSE}
  GAMmap(sdf %>% filter(SCREEN_TOP_DEPTH_M<20))
```

<br>

### Deeper system groundwater levels

GAM modelled seasonal groundwater level variability for deeper (>20m) wells.

<!-- <iframe src="https://golang.oakridgeswater.ca/pages/gwvar-map-leaflet-GAM-deep.html" width="100%" height="400" scrolling="no" allowfullscreen></iframe> -->

```{r GAMdeep, echo=FALSE, message=FALSE, warning=FALSE}
  GAMmapDeep(sdf %>% filter(SCREEN_TOP_DEPTH_M>=20))
```

<br>

### Distributions

```{r GAMhisto, echo=FALSE, message=FALSE, warning=FALSE}
  med = median(sdf$GAMrange, na.rm=TRUE)
  sdf %>% drop_na(GAMrange) %>% 
    mutate(wells=case_when( SCREEN_TOP_DEPTH_M<20 ~ "shallow", TRUE ~ "deep" )) %>% 
    ggplot(aes(GAMrange, fill=wells)) +
      theme_bw() + theme(legend.position = c(.9,.9), legend.justification = c(1,1)) +
      geom_histogram(position = "dodge",binwidth = 0.2,center=0.1) +
      geom_vline(xintercept=med, linetype='dotted') +
      scale_fill_manual(values = cols) +
      labs(title=paste0("Distribution of groundwater level ranges (median = ±",round(med,1),"m)"), x="range (±m)")
```

<br>

#### By formation

```{r GAMhisto.formation, echo=FALSE, message=FALSE, warning=FALSE}

  layers_ordered <- c(
    "Late Stage Glaciolacustrine-Glaciofluvial",
    "Halton Till",
    "Mackinaw/Oak Ridges",
    "Channel - Silt",
    "Channel - Sand",
    "Upper Newmarket",
    "Inter Newmarket Sediment",
    "Lower Newmarket",
    "Newmarket Till/Northern Till",
    "Thorncliffe",
    "Sunnybrook",
    "Scarborough",
    "Bedrock - Undifferentiated",
    "unknown"
  )

  layer.cols <- c("#cb4f31", "#52c274", "#c25abc", "#65af3a", "#7a67ca", "#b6b138", "#6b8fce", "#d79139", "#4cbdaf", "#d1416d", "#447f47", "#bc6990", "#a0b26a", "#c77a5c")

  sdf %>% drop_na(c(GAMrange)) %>% 
    mutate(FORMATION = str_replace(FORMATION, ' \\(ORMGP\\)', '')) %>%
    filter(FORMATION != "") %>%
    filter(FORMATION != "Newmarket Till/Northern Till") %>% # removes 2 points
    # mutate(FORMATION = ifelse(FORMATION == "", "unknown", FORMATION)) %>%
    mutate(FORMATION=factor(FORMATION, levels = rev(layers_ordered))) %>%
    ggplot(aes(FORMATION, GAMrange, fill=FORMATION)) +
      theme_bw() +
      # theme(legend.position = 'bottom') +
      geom_violin() +
      geom_jitter(width=.1,alpha=.1) +
      scale_fill_manual(values = layer.cols, guide='none') +
      labs(title="Distribution of groundwater level ranges (by formation)", x=NULL, y="range (±m)") +
      coord_flip() +
      scale_x_discrete(position = 'top')
```

<br>

```{r GAMtable.formation, echo=FALSE, message=FALSE, warning=FALSE}
  sdf %>% drop_na(c(GAMrange)) %>% 
    mutate(FORMATION = str_replace(FORMATION, ' \\(ORMGP\\)', '')) %>%
    filter(FORMATION != "") %>%
    # mutate(FORMATION = ifelse(FORMATION == "", "unknown", FORMATION)) %>%
    mutate(FORMATION=factor(FORMATION, levels = layers_ordered)) %>%
    group_by(FORMATION) %>%
    summarise(n=n(), 
              mean=mean(GAMrange), 
              geomean=exp(mean(log(GAMrange))), 
              median=median(GAMrange)) %>%
    knitr::kable(caption= "Summary table, groundwater range (±m) by formation", format='html', digits=2) %>%
  kableExtra::kable_styling(full_width = F)
    
```

<br>

## Long-term Trend (last 10 years)

Groundwater level monitoring over the past decade has been put to the Mann-Kendall test for trend. The maps below identify wells that have exhibited a statistically significant trend (increasing or decreasing or none) change over the past 10 years.

Mann-Kendall test for trend.

- Blue Triangles: increasing trend (p<0.05)
- Orange Triangles: decreasing trend (p<0.05)
- Circles: no trend


> hovering on any triangle to reveal station properties, click for more details. Full-screen available in the top-left corner


```{r funcMKmap, include=FALSE}
  source("func/MKmap.R", local = TRUE)$value
```

### Shallow (<20m) wells

<!-- <iframe src="https://golang.oakridgeswater.ca/pages/gwvar-map-leaflet-MK-shallow.html" width="100%" height="400" scrolling="no" allowfullscreen></iframe> -->

```{r MKshallow, echo=FALSE, message=FALSE, warning=FALSE}
  MKmap(sdf %>% drop_na(MannKendall10yrTau) %>% filter(SCREEN_TOP_DEPTH_M<20))
```

<br>

### Deep (>20m) wells

<!-- <iframe src="https://golang.oakridgeswater.ca/pages/gwvar-map-leaflet-MK-deep.html" width="100%" height="400" scrolling="no" allowfullscreen></iframe> -->

```{r MKdeep, echo=FALSE, message=FALSE, warning=FALSE}
  MKmap(sdf %>% drop_na(MannKendall10yrTau) %>% filter(SCREEN_TOP_DEPTH_M>=20))
```


<br>

### Distributions

```{r MKhisto, echo=FALSE, message=FALSE, warning=FALSE}
  sdf %>% drop_na(MannKendall10yrTau) %>% 
    mutate(trend=case_when(MannKendall10yrPstat<0.05 & MannKendall10yrTau>0 ~ 'increasing',
                           MannKendall10yrPstat<0.05 & MannKendall10yrTau<0 ~ 'decreasing',
                           TRUE ~ 'none')) %>%
    mutate(wells=case_when(SCREEN_TOP_DEPTH_M<20 ~ "shallow", TRUE ~ "deep")) %>% 
    ggplot(aes(trend, fill=wells)) +
      theme_bw() +
      geom_bar(position = "dodge") +
      scale_fill_manual(values = cols) +
      labs(title="Mann-Kendall test for trend, past 10yrs.")
```



<br><hr><br>

# References

Wood, S.N., 2017. Generalized Additive Models: An introduction with R, 2nd ed. CRC Press. 476pp.


<br>
<hr>
<br>

# Extras

## Presentations

[Marchildon et.al. CWRA 2023 National Conference poster](https://golang.oakridgeswater.ca/pages/2023/Marchildon_et_al-CWRA%202023%20National%20Conference-poster.pdf)


## Complete GAM formulation

$$
    g(\mu_i)=\mathbf{A}_i\boldsymbol\theta +
    \sum_{n=1}^{p}b_{n}(t)\beta_{n} +
    \sum_{m=1}^{12}\tilde{b}_m(t)\beta_m +
    \mathbf{Z}_i\mathbf{b}
$$

where $\mathbf{A}_i$ is the $i^\text{th}$ row of a model matrix $\mathbf{A}$, $\boldsymbol\theta$ is the parameter vector. $\boldsymbol\theta$ can be leveraged to handle pumping influences; $\tilde{b}_m(t)$ is the cyclic basis function for month $m$ at time $t$ multiplied by some parameter $\beta_m$; and $\mathbf{Z}_i\mathbf{b}\quad(\mathbf{b}\sim N(\mathbf{0},\boldsymbol\psi))$ is the error term.




## Example in ggplot

```{r gam1}
cdf <- gamm(data=exampldf, Val~s(doy,bs="cc",k=12)+s(as.numeric(yr),bs="cr"), correlation=corAR1(form=~1|yr))
exampldf %>% ggplot(aes(date,Val)) +
  theme_bw() +
  geom_line(aes(colour='observed')) +
  geom_line(data=data.frame(Val = cdf$gam$fitted.values, date = exampldf$date), aes(colour='modelled')) +
  labs(x=NULL, y="water level (masl)")
```


```{r trend}
print(summary(cdf$gam))

layout(matrix(1:2, nrow = 1))
plot(cdf$gam, scale=0)
gam.check(cdf$gam)

intervals(cdf$lme,which = "var-cov")
cdf$gam$sig2/cdf$gam$sp
```


*simultaneous interval for a penalized spline in a fitted Generalized additive model (GAM)*


<br><hr><br>

## see also

[**Groundwater and Flooding**](gwflooding.html): investigating the causal nature of groundwater flooding through simulation.
