---
title: "CTC Source Protection Region Municipal Wells Water Quality Status, Trends, and Projections"
subtitle: "Statistical analysis of municipal water quality parameters in the CTC Source Protection Region"
author: "Oak Ridges Moraine Groundwater Program and CTC Source Protection Region"
date: "`r gsub(' 0', ' ', format(Sys.time(), '%d %B, %Y'))`"
output:
  html_document:
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sf)
library(leaflet)
library(leaflet.extras)
library(dplyr)
library(tidyr)
library(gt)
library(stringr)
sf_use_s2(FALSE)

# https://stackoverflow.com/questions/72296705/how-to-add-triangles-when-customizing-a-leaflet-legend-in-r
addLegendCustom <- function(map, colors, labels, sizes, shapes, borders, opacity = 0.5){
  make_shapes <- function(colors, sizes, borders, shapes) {
    shapes <- gsub("circle", "50%", shapes)
    shapes <- gsub("square", "0%", shapes)
    paste0(colors, "; width:", sizes, "px; height:", sizes, "px; border:3px solid ", borders, "; border-radius:", shapes)
  }
  make_labels <- function(sizes, labels) {
    paste0("<div style='display: inline-block;height: ", 
           sizes, "px;margin-top: 4px;line-height: ", 
           sizes, "px;'>", labels, "</div>")
  }
  
  legend_colors <- make_shapes(colors, sizes, borders, shapes)
  legend_labels <- make_labels(sizes, labels)
  
  return(addLegend(map, colors = legend_colors, labels = legend_labels, opacity = opacity))
}

ormgp.bound <- read_sf("E:/Sync/@owrc/geojson/ORMGP_region.geojson")
ctc.bound <- read_sf('shp/CTC-smpl.geojson')
wells.loc <- read.csv('dat/locations-stats.csv') %>%
  mutate(Cl.current=round(Cl.current,2),Cl.first=round(Cl.first,2),Cl.pred.GAM=round(Cl.pred.GAM,2),Cl.pred.LM=round(Cl.pred.LM,2)) %>%
  mutate(Na.current=round(Na.current,2),Na.first=round(Na.first,2),Na.pred.GAM=round(Na.pred.GAM,2),Na.pred.LM=round(Na.pred.LM,2)) %>%
  mutate(NO3.current=round(NO3.current,2),NO3.first=round(NO3.first,2),NO3.pred.GAM=round(NO3.pred.GAM,2),NO3.pred.LM=round(NO3.pred.LM,2))

muni.sf <- read_sf('E:/Sync/@gis/Boundaries/municipal/MUNICIPAL_BOUNDARY_open_data_shapefiles/MUNICIPAL_BOUNDARY_UPPER_TIER_AND_DISTRICT.shp')

pnts_sf <- st_as_sf(wells.loc %>% filter(!is.na(LAT)), coords = c('LONG', 'LAT'), crs = st_crs(muni.sf))
wells.loc.rfmt <- pnts_sf %>% 
  mutate(intersection = as.integer(st_intersects(geometry, muni.sf)), Municipality = if_else(is.na(intersection), '', muni.sf$NAME[intersection])) %>%
  dplyr::select(-c(LOC_ID,LOC_NAME,LOC_NAME_ALT1,GRND_ELEV,loc.id,intersection)) %>%
  st_drop_geometry() 

up.arr = "\u2191"
up.arr.str = paste0(up.arr,"*")
dwn.arr = "\u2193"
dwn.arr.str = paste0(dwn.arr,"*")
none.arr = "\u2194"
trnd.trsh = 0.005

icons.up <- makeIcon(
  iconUrl = 'icons/arrow-up-outline.svg',
  iconWidth = 31*215/230,
  iconHeight = 31, 
  iconAnchorY = 16,
  iconAnchorX = 1.05*31*215/230/2,
)
icons.dwn <- makeIcon(
  iconUrl = 'icons/arrow-down-outline.svg',
  iconWidth = 31*215/230,
  iconHeight = 31, 
  iconAnchorY = 16,
  iconAnchorX = .95*31*215/230/2,
)
```

# Introduction

The *Clean Water Act, 2006* (CWA) and its associated regulations aim to protect existing and future sources of drinking water before it enters the municipal drinking water treatment system. The CWA established a locally driven, science-based, multi-stakeholder process to protect municipal drinking water sources and designated private drinking water sources. This process is meant to promote the shared responsibility of all stakeholders to protect local sources of drinking water from threats to both water quantity and quality. 

In compliance with the *Safe Drinking Water Act, 2002*, the quality of municipal drinking water must be monitored to ensure it meets provincial standards. Regular sampling and testing of raw, treated, and distributed drinking water is performed for several organic, inorganic, physical and radiological parameters. From a drinking water source protection perspective, emphasis is placed on three inorganic parameters — sodium (Na), chloride (Cl) and nitrate (NO3) — since they are commonly sampled, are typical indications of surface activity, and are mobile in the groundwater flow system.

Water quality trend analysis and accompanying plots are tools used to identify deteriorating source water quality conditions before they become a drinking water *Issue.* They can also be used to both isolate what may be contributing to the identified *Issue*, as well as improve our understanding of the impact of existing Drinking Water Source Protection Plan policy’s ability to protect the quality of source water.

## Oak Ridges Moraine Groundwater Program (ORMGP)

The [Oak Ridges Moraine Groundwater Program](https://www.oakridgeswater.ca/) reflects the intent of fifteen government agencies (municipalities and conservation authorities) to jointly manage, synthesize and disseminate water resources data, analysis, knowledge, geologic interpretations, and numerical models over a 30,000 km² area situated in south-central Ontario.

## CTC Source Protection Region

The CTC Source Protection Region contains 25 large and small watersheds and spans from the Oak Ridges Moraine in the north to Lake Ontario in the south. The region contains portions of the Niagara Escarpment, Oak Ridges Moraine, Greenbelt, Lake Ontario, and the most densely populated region of Canada. The CTC Source Protection Region includes: 

- 25 local municipalities and eight single tier, regional or county municipalities; 
- 63 active municipal supply wells; and 
- 16 municipal surface water intakes on Lake Ontario. 

The region is complex and diverse in terms of geology, physiology, population, and development pressures. This diverse setting represents a significant challenge because of the variability of available information upon which to base the technical work, the differing stresses on water resources related to development pressure and population growth, and the differences in the nature, density, and locations of threats to the quality and quantity of water resources.

<!-- `click square in upper-left corner to enable full-screen mode` -->

<!-- ```{r basemap1, echo=FALSE, warning=FALSE} -->
<!-- leaflet(ctc.bound) %>% -->
<!--   setView(lng = -79.45, lat = 43.84, zoom = 9) %>% -->
<!--   addFullscreenControl() %>% -->
<!--   addTiles() %>% -->
<!--   addPolygons(data = ormgp.bound, -->
<!--               weight = 4, -->
<!--               color = "darkred", -->
<!--               fill = FALSE, -->
<!--               opacity = .4, -->
<!--               options = pathOptions(clickable = FALSE) -->
<!--   ) %>% -->
<!--   addPolygons(weight = 2, -->
<!--               color = "black", -->
<!--               fill=FALSE, -->
<!--               dashArray = c(10, 5), -->
<!--               opacity = .8, -->
<!--               options = pathOptions(clickable = FALSE) -->
<!--   ) %>% -->
<!--   addMarkers(data = wells.loc, -->
<!--              lat = ~LAT, lng= ~LONG, -->
<!--              label = ~Name) %>% -->
<!--   addLegendCustom(colors = 'white', labels = c('CTC','ORMGP'), sizes = 20, shapes = 'square', borders = c('black','darkred'), opacity = 1.) -->
<!-- ``` -->

<!-- ***Map 1.** CTC Source Protection Region jurisdiction and the ORMGP jurisdiction.* -->

![](img/CTC_Map.jpg)
***Map 1.** CTC Source Protection Region jurisdiction.*

<br>


# Purpose of the snapshot

Water quality parameter data collected from municipal wells are regularly analyzed to determine if a specific parameter: 

1. Exceeds the applicable Ontario Drinking Water Quality Standard (ODWQS), 
1. Statistical projections show the potential for concentrations to increase above the applicable ODWQS threshold within a defined projection period, or 
1. The frequency with which the half concentration of the ODWQS threshold was met or exceeded. 

The CTC Source Protection Region Municipal Wells Water Quality Status, Trends, and Projections snapshot provides a platform for users to analyze municipal well water quality data using preferred statistical analysis methods. Through this platform, specific water quality parameters can be evaluated through statistical status, trend, and projection analysis to monitor changes over time.  

# Methodology

There are many analytic techniques available to assess water quality trends, model, or project future concentrations, and test the influence of different factors in the observed trends. These different approaches vary in their assumptions, flexibility, and ability to meet analytic objectives.

## Ontario Drinking Water Quality Standard (ODWQS)

Groundwater chemistry is evaluated based on the Ontario Drinking Water Quality Standards Guidelines (ODWQS; MOE, 2006). ODWQS has defined an aesthetic objective for chloride of 250 mg/L, sodium of 200 mg/L and a maximum acceptable concentration for nitrite + nitrate (i.e., nitrate) of 10 mg/L. Regarding municipal drinking water wells, the Local Medical Officer of Health is notified when sodium concentrations exceed 20 mg/L so that information may be communicated to local physicians for use with patients on sodium reduced diets. 
The focus on chloride, sodium, and nitrate is to identify and differentiate natural versus anthropogenic impacts on groundwater quality. An increasing trend over time in these parameters shows an anthropogenic impact. In addition, these three parameters have been identified as existing drinking water *Issues* in the CTC Source Protection Region.

## Generalized Additive Mixed Model (GAMM)

Generalized additive models are an extension of simple regressions, where the distribution is not defined. These models are particularly useful for data sets with non-normal error distributions (i.e., proportions, counts, or when they do not have negative values) and when data points are not independent. This makes the GAMM a good approach for environmental monitoring data. In addition, these models are non-parametric, so data do not need to be normalized. This ensures that the relationship between the predictor and independent factor are not modified in the transformation process. These models are also able to include covariates and predictors, to help explain the observed trends, so we can isolate drivers behind an observed *Issue*, and better develop a management response to improve conditions. 

Notably, GAMMs can identify patterns in the data that are more difficult to detect with other techniques. This is because the models are non-monotonic and can pick up on periods of increase and decrease within a year, and across years (**Figure 1**). Being able to isolate trends in months or seasons improves the effectiveness of mitigation recommendations.

![](img/F01-GAMM-sample.png){width=70%}

***Figure 1.** Example of a GAMM, with trend line and 95% confidence intervals. The data points and trend line are plotted against the ODWQS (maximum acceptable concentration; higher dashed grey line) to determine if concentrations exceed guidelines throughout the monitoring period.*

<br>

A hybrid approach using linear regression and GAMM is used to identify projected guideline exceedances (**Figure 2**). Specifically, the certainty of exceeding a guideline is described as follows: 

- when forecasts from both statistical tests show an exceedance, an *Issue* is considered ***highly likely***. 
- when only one test shows an exceedance, an *Issue* is ***somewhat likely***. 
- if neither trend lines exceeds, or shows a decreasing trend, an *Issue* is ***not likely***. 

![](img/F02-linear-GAMM.png)

***Figure 2.** Example of how information from the linear regression and GAMM can be used to identify guideline exceedances and trends.*

<br>

Importantly, the projection period should not exceed the length of the data record used to estimate a statistical trend or baseline period (e.g., if a 20-year monitoring period is available, the projections should not extend more than 20 years into the future). However, the Drinking Water Source Protection Plan policies are interested in projecting concentrations to 2040. Unfortunately, the data record is not long enough for some wells to project to 2040 with confidence. Although these projections are provided, they are assigned a confidence score. Where the existing data record is shorter than how far into the future the projections are made, it is assigned a ‘***low confidence***’. When the existing data record is as long or exceeds how far into the future the projections are made, this is assigned a ‘***moderate confidence***’.

## Application of statistical analysis and data requirements  

Groundwater chemistry data is analyzed for sixty-six municipal production wells across six regional municipalities in the CTC Source Protection Region. Monitoring duration was highly variable, ranging from a low of one year and up to thirty-eight years. For each well, groundwater samples were collected multiple times during each monitoring year, ranging from one to fifty-four times in any given year.

To be included in the analyses the data had to meet the following conditions: 

- Include more than two discrete values (i.e., could not be all 0 with one different value).
- Contain a minimum of at least four years of uninterrupted monitoring data. If a 2-year gap in monitoring was present, the monitoring period post gap had to be a minimum of four years.
- Contain no unreliable values, such as extreme outliers that were likely due to data entry, lab, sampling, or other anthropogenic errors. 

The data records that did not meet the requirements were for two main reasons: 

1. large data gaps, or 
1. samples all had the same concentrations and were therefore below the detection limit. 

To run the monthly GAMM, a minimum of ten months of data per year were required across the monitoring period.

## Annual trends and projections

The purpose of any trend analysis is to identify and quantify trends in a parameter of interest, after controlling for the many potential sources of variability in a dataset. This will show whether conditions are improving or deteriorating. Besides identifying how conditions are changing over time, some approaches can be used to identify if the parameter of interest is responding to the implementation of management measures or conservation actions. 

Parameter concentrations in each of the wells were compared to the applicable ODWQS objectives, to determine if concentrations exceed the objectives in both the most recent year of data and into the future. For the most recent year of data, this was done by simply reporting whether the median concentration values for that year exceeds the objectives. 

Statistical tests were used to plot trends in groundwater chemistry as a visual aid (**Figure 3**). Annual trends over the monitoring period are produced using GAMM to show periods of increase and decrease. Monthly plots are produced to compare across two years – the first and last year of the monitoring period with a full data record. Lastly, projection plots show groundwater chemistry trends and evaluate the likelihood of exceeding the ODWQS objective in the future. By extending the trend lines into the future using slope estimates from each of the models (GAMM and linear regression), predictions can be made as to whether parameter concentrations are likely to exceed the objectives by a defined period.   

![](img/F03-trend-plots-ex.png)

***Figure 3**. Examples of trend plots derived from GAMM analysis. A) annual non-monotonic trends where periods of increase are bolded in red, and periods of decrease are bolded in green. B) monthly variation in groundwater chemistry concentrations in the first and last year of the monitoring period. C) projections of parameter concentrations to 2040 based on linear regression and GAMM.*  

<br>

### Conditions

To be included in the trend analysis, a well needed to have at least four years of monitoring data. Tests were run on individual wells using the full continuous data record available, unless there were large monitoring gaps present. If gaps exceeded two years in duration, only the data after the gap were analyzed.

# Results

Statistical tests and trend analysis using the GAMM method were completed on chloride, sodium, and nitrate data from sixty-six municipal production wells across six regional municipalities in the CTC Source Protection Region. 

**Download** annual and projection trend analysis plots for the sixty-six municipal production wells in the CTC Source Protection Region (`make this a hyperlink to the plots`). Example provided below.

![](img/f04-nitrate-ex.png){width=80%}

***Figure 5**. Sample nitrate concentration at Davidson 1 is currently below the half-Maximum Acceptable Concentration (MAC) of 5 mg/L and is showing a significantly decreasing trend. Nitrate concentration is unlikely to exceed the half-MAC of 5 mg/L by 2040.* 

<br>

<!-- **Tabular** form here (`make this a hyperlink to the spreadsheet`). Example provided below.   -->

<!-- ***Table 1**. Sample summary of municipal production wells with existing or potential Nitrate Issues. The row in **bold font** is a municipal production well with an existing Nitrate Issue. For the current period, concentrations are based on median observed values, and trends are based on GAMM results. For 2040 projections, concentrations and trend directions are based on GAMMs, and likelihood of exceedance is based on comparison of GAMM and linear regression.*  -->

<!-- ![](img/summary-muni-table.png) -->

For the **detailed methodology** applied to produce the plots, please refer to the [**CTC Source Protection Region Water Quality Assessment Report**](https://www.ctcswp.ca/who-we-are/meetings/rpt_20231108_ctc-water-quality-assessment-technical-report_fnl.pdf). 

Maps providing an overview of the status and trend results for the sixty-six municipal production wells are presented below. In all the figures, the term Maximum Acceptable Concentration (MAC) and ODWQS refer to the same threshold and are interchangeable.

<br>

### Chloride by well

Summary of municipal production wells with existing or potential Chloride Issues. For the current period, concentrations are based on median observed values, and trends are based on GAMM results. For 2040 projections, concentrations and trend directions are based on GAMMs, and likelihood of exceedance is based on comparison of GAMM and linear regression.


```{r tbl.Cl, echo=FALSE, warning=FALSE}
wells.loc.rfmt %>%
  drop_na() %>%
  mutate(Location_Municipality=str_to_title(Municipality),Location_Well=Name) %>%
  mutate('Current_Concentration (mg/L)'=Cl.current,'Current_Magnitude of change (mg/L)'=Cl.current-Cl.first) %>%
  mutate('2024 Projections_2040 Concentration (mg/L)'=if_else(Cl.pred.GAM>0,Cl.pred.GAM,0),'2024 Projections_Magnitude of change (mg/L)'=Cl.pred.GAM-Cl.current) %>%
  mutate('Current_Comparison to ODWQS'=if_else(Cl.current<10,'Below','Above')) %>%
  mutate('2024 Projections_Likelihood of exceeding ODWQS'=if_else(Cl.status==2,'Likely',if_else(Cl.status==1,'Somewhat likely','Unlikely'))) %>%
  mutate('Current_Trend direction'=if_else(Cl.cur.trnd > trnd.trsh,
                                   if_else(Cl.cur.trnd.sig==1,up.arr.str,up.arr),
                           if_else(Cl.cur.trnd < -trnd.trsh,
                                   if_else(Cl.cur.trnd.sig==1,dwn.arr.str,dwn.arr),
                           none.arr))) %>%
  mutate('2024 Projections_Trend direction'=if_else(Cl.fut.trnd > trnd.trsh,
                                   if_else(Cl.fut.trnd.sig==1,up.arr.str,up.arr),
                                   if_else(Cl.fut.trnd < -trnd.trsh,
                                           if_else(Cl.fut.trnd.sig==1,dwn.arr.str,dwn.arr),
                                           none.arr))) %>%
  dplyr::select(c(Location_Municipality,Location_Well,
                  'Current_Concentration (mg/L)','Current_Comparison to ODWQS','Current_Trend direction','Current_Magnitude of change (mg/L)',
                  '2024 Projections_2040 Concentration (mg/L)','2024 Projections_Likelihood of exceeding ODWQS','2024 Projections_Trend direction','2024 Projections_Magnitude of change (mg/L)')) %>%
  arrange(Location_Municipality,Location_Well) %>%
  gt() %>%
  # tab_header(title="Nitrate") %>%
  tab_spanner_delim(delim = "_") %>%
  tab_options(container.height = 600, 
              column_labels.background.color = "lightblue",
              table.font.size = '12px') %>% 
  tab_style(
    style = css(position = "sticky", top = px(-10), zIndex = 100),
    locations = list(cells_column_spanners(), cells_column_labels())
  ) 
```

<br>

### Sodium by well

Summary of municipal production wells with existing or potential Sodium Issues. For the current period, concentrations are based on median observed values, and trends are based on GAMM results. For 2040 projections, concentrations and trend directions are based on GAMMs, and likelihood of exceedance is based on comparison of GAMM and linear regression.


```{r tbl.Na, echo=FALSE, warning=FALSE}
wells.loc.rfmt %>%
  drop_na() %>%
  mutate(Location_Municipality=str_to_title(Municipality),Location_Well=Name) %>%
  mutate('Current_Concentration (mg/L)'=Na.current,'Current_Magnitude of change (mg/L)'=Na.current-Na.first) %>%
  mutate('2024 Projections_2040 Concentration (mg/L)'=if_else(Na.pred.GAM>0,Na.pred.GAM,0),'2024 Projections_Magnitude of change (mg/L)'=Na.pred.GAM-Na.current) %>%
  mutate('Current_Comparison to ODWQS'=if_else(Na.current<200,'Below','Above')) %>%
  mutate('2024 Projections_Likelihood of exceeding ODWQS'=if_else(Na.status==2,'Likely',if_else(Na.status==1,'Somewhat likely','Unlikely'))) %>%
  mutate('Current_Trend direction'=if_else(Na.cur.trnd > trnd.trsh,
                                   if_else(Na.cur.trnd.sig==1,up.arr.str,up.arr),
                           if_else(Na.cur.trnd < -trnd.trsh,
                                   if_else(Na.cur.trnd.sig==1,dwn.arr.str,dwn.arr),
                           none.arr))) %>%
  mutate('2024 Projections_Trend direction'=if_else(Na.fut.trnd > trnd.trsh,
                                   if_else(Na.fut.trnd.sig==1,up.arr.str,up.arr),
                                   if_else(Na.fut.trnd < -trnd.trsh,
                                           if_else(Na.fut.trnd.sig==1,dwn.arr.str,dwn.arr),
                                           none.arr))) %>%
  dplyr::select(c(Location_Municipality,Location_Well,
                  'Current_Concentration (mg/L)','Current_Comparison to ODWQS','Current_Trend direction','Current_Magnitude of change (mg/L)',
                  '2024 Projections_2040 Concentration (mg/L)','2024 Projections_Likelihood of exceeding ODWQS','2024 Projections_Trend direction','2024 Projections_Magnitude of change (mg/L)')) %>%
  arrange(Location_Municipality,Location_Well) %>%
  gt() %>%
  # tab_header(title="Nitrate") %>%
  tab_spanner_delim(delim = "_") %>%
  tab_options(container.height = 600, 
              column_labels.background.color = "lightblue",
              table.font.size = '12px') %>% 
  tab_style(
    style = css(position = "sticky", top = px(-10), zIndex = 100),
    locations = list(cells_column_spanners(), cells_column_labels())
  ) 
```

<br>


### Nitrate by well

Summary of municipal production wells with existing or potential Nitrate Issues. For the current period, concentrations are based on median observed values, and trends are based on GAMM results. For 2040 projections, concentrations and trend directions are based on GAMMs, and likelihood of exceedance is based on comparison of GAMM and linear regression.


```{r tbl.N03, echo=FALSE, warning=FALSE}
wells.loc.rfmt %>%
  drop_na() %>%
  mutate(Location_Municipality=str_to_title(Municipality),Location_Well=Name) %>%
  mutate('Current_Concentration (mg/L)'=NO3.current,'Current_Magnitude of change (mg/L)'=NO3.current-NO3.first) %>%
  mutate('2024 Projections_2040 Concentration (mg/L)'=if_else(NO3.pred.GAM>0,NO3.pred.GAM,0),'2024 Projections_Magnitude of change (mg/L)'=NO3.pred.GAM-NO3.current) %>%
  mutate('Current_Comparison to ODWQS'=if_else(NO3.current<10,'Below','Above')) %>%
  mutate('2024 Projections_Likelihood of exceeding ODWQS'=if_else(NO3.status==2,'Likely',if_else(NO3.status==1,'Somewhat likely','Unlikely'))) %>%
  mutate('Current_Trend direction'=if_else(NO3.cur.trnd > trnd.trsh,
                                   if_else(NO3.cur.trnd.sig==1,up.arr.str,up.arr),
                           if_else(NO3.cur.trnd < -trnd.trsh,
                                   if_else(NO3.cur.trnd.sig==1,dwn.arr.str,dwn.arr),
                           none.arr))) %>%
  mutate('2024 Projections_Trend direction'=if_else(NO3.fut.trnd > trnd.trsh,
                                   if_else(NO3.fut.trnd.sig==1,up.arr.str,up.arr),
                                   if_else(NO3.fut.trnd < -trnd.trsh,
                                           if_else(NO3.fut.trnd.sig==1,dwn.arr.str,dwn.arr),
                                           none.arr))) %>%
  dplyr::select(c(Location_Municipality,Location_Well,
                  'Current_Concentration (mg/L)','Current_Comparison to ODWQS','Current_Trend direction','Current_Magnitude of change (mg/L)',
                  '2024 Projections_2040 Concentration (mg/L)','2024 Projections_Likelihood of exceeding ODWQS','2024 Projections_Trend direction','2024 Projections_Magnitude of change (mg/L)')) %>%
  arrange(Location_Municipality,Location_Well) %>%
  gt() %>%
  # tab_header(title="Nitrate") %>%
  tab_spanner_delim(delim = "_") %>%
  tab_options(container.height = 600, 
              column_labels.background.color = "lightblue",
              table.font.size = '12px') %>%  
  tab_style(
    style = css(position = "sticky", top = px(-10), zIndex = 100),
    locations = list(cells_column_spanners(), cells_column_labels())
  ) 
```


<br>


# Maps: Projections

Status of each well in reference to the applicable half-Maximum Allowable Concentration and ODWQS objectives based on the most recent year of data. `Hover over any point to reveal municipal well properties, click for more details.` 

```{r mappal, echo=FALSE, warning=FALSE}
  pal <- colorNumeric(c("black", "purple", "red"), 0:2)
```

### Chloride projections

`click square in upper-left corner to enable full-screen mode`

```{r clmap, echo=FALSE, warning=FALSE}
leaflet(ctc.bound) %>%
  setView(lng = -79.45, lat = 43.84, zoom = 9) %>%
  addFullscreenControl() %>%
  addTiles() %>%
  addPolygons(weight = 2,
              color = "black",
              fill=FALSE,
              dashArray = c(10, 5),
              opacity = .4,
              options = pathOptions(clickable = FALSE)
  ) %>%
  addCircleMarkers(data = wells.loc %>% filter(!is.na(Cl.status)),
                   lat = ~LAT, lng= ~LONG,
                   radius = ~Cl.status*4,
                   color = ~pal(Cl.status),
                   opacity = 1,
                   fillOpacity = 1,
                   label = ~Name, 
                   popup = ~paste0(#'<style> div.leaflet-popup-content {width:auto !important;}</style>',
                                   '<b>',Name,'</b>',
                                   '<br>ODWQS exceedance: ',case_when(Cl.status==0 ~ 'unlikely',
                                                              Cl.status==1 ~ 'somewhat likely',
                                                              Cl.status==2 ~ 'highly likely'),
                                   '<br>confidence: ', Cl.conf,
                                   '<br>current conc: ', Cl.current,' mg/L',
                                   '<br>projected conc: ', Cl.pred.GAM,' mg/L',
                                   '<br><a href="https://golang.oakridgeswater.ca/pages/CTC/Chloride/', LOC_ID, '.png"><img src = https://golang.oakridgeswater.ca/pages/CTC/Chloride/', LOC_ID, '.png width="600"></a>',
                                   '<br>click image to expand'),
                   options = popupOptions(maxWidth = 1000)
                   ) %>%
  addLegendCustom(colors = c('black','purple','red','white'), 
                  labels = c('unlikely','somewhat likely','highly likely','CTC jurisdiction'), 
                  sizes = c(2,7,15,15), 
                  shapes = c('circle','circle','circle','square'), 
                  borders = c('black','purple','red','black'), 
                  opacity = 1.)
```


### Sodium projections

`click square in upper-left corner to enable full-screen mode`

```{r namap, echo=FALSE, warning=FALSE}
leaflet(ctc.bound) %>%
  setView(lng = -79.45, lat = 43.84, zoom = 9) %>%
  addFullscreenControl() %>%
  addTiles() %>%
  addPolygons(weight = 2,
              color = "black",
              fill=FALSE,
              dashArray = c(10, 5),
              opacity = .4,
              options = pathOptions(clickable = FALSE)
  ) %>%
  addCircleMarkers(data = wells.loc %>% filter(!is.na(Na.status)),
                   lat = ~LAT, lng= ~LONG,
                   radius = ~Na.status*4,
                   color = ~pal(Na.status),
                   opacity = 1,
                   fillOpacity = 1,
                   label = ~Name, 
                   popup = ~paste0(#'<style> div.leaflet-popup-content {width:auto !important;}</style>',
                                   '<b>',Name,'</b>',
                                   '<br>ODWQS exceedance: ',case_when(Na.status==0 ~ 'unlikely',
                                                              Na.status==1 ~ 'somewhat likely',
                                                              Na.status==2 ~ 'highly likely'),
                                   '<br>confidence: ', Na.conf,
                                   '<br>current conc: ', Na.current,' mg/L',
                                   '<br>projected conc: ', Na.pred.GAM,' mg/L',
                                   '<br><a href="https://golang.oakridgeswater.ca/pages/CTC/Sodium/', LOC_ID, '.png"><img src = https://golang.oakridgeswater.ca/pages/CTC/Sodium/', LOC_ID, '.png width="600"></a>',
                                   '<br>click image to expand'),
                   ) %>%
  addLegendCustom(colors = c('black','purple','red','white'), 
                  labels = c('unlikely','somewhat likely','highly likely','CTC jurisdiction'), 
                  sizes = c(2,7,15,15), 
                  shapes = c('circle','circle','circle','square'), 
                  borders = c('black','purple','red','black'), 
                  opacity = 1.)
```


### Nitrate projections

`click square in upper-left corner to enable full-screen mode`

```{r no3map, echo=FALSE, warning=FALSE}
leaflet(ctc.bound) %>%
  setView(lng = -79.45, lat = 43.84, zoom = 9) %>%
  addFullscreenControl() %>%
  addTiles() %>%
  addPolygons(weight = 2,
              color = "black",
              fill=FALSE,
              dashArray = c(10, 5),
              opacity = .4,
              options = pathOptions(clickable = FALSE)
  ) %>%
  addCircleMarkers(data = wells.loc %>% filter(!is.na(NO3.status)),
                   lat = ~LAT, lng= ~LONG,
                   radius = ~NO3.status*4,
                   color = ~pal(NO3.status),
                   opacity = 1,
                   fillOpacity = 1,
                   label = ~Name, 
                   popup = ~paste0('<b>',Name,'</b>',
                                   '<br>ODWQS exceedance: ',case_when(NO3.status==0 ~ 'unlikely',
                                                              NO3.status==1 ~ 'somewhat likely',
                                                              NO3.status==2 ~ 'highly likely'),
                                   '<br>confidence: ', NO3.conf,
                                   '<br>current conc: ', NO3.current,' mg/L',
                                   '<br>projected conc: ', NO3.pred.GAM,' mg/L',
                                   '<br><a href="https://golang.oakridgeswater.ca/pages/CTC/Nitrate/', LOC_ID, '.png"><img src = https://golang.oakridgeswater.ca/pages/CTC/Nitrate/', LOC_ID, '.png width="600"></a>',
                                   '<br>click image to expand'),
                   ) %>%
  addLegendCustom(colors = c('black','purple','red','white'), 
                  labels = c('unlikely','somewhat likely','highly likely','CTC jurisdiction'), 
                  sizes = c(2,7,15,15), 
                  shapes = c('circle','circle','circle','square'), 
                  borders = c('black','purple','red','black'), 
                  opacity = 1.)
```

<br>

# Maps: Trends

Summary of municipal production well Trends. For the current period, concentrations are based on median observed values, and trends are based on GAMM results. For 2040 projections, concentrations and trend directions are based on GAMMs, and likelihood of exceedance is based on comparison of GAMM and linear regression.


### Chloride trends

`click square in upper-left corner to enable full-screen mode`

```{r Cl.trnd.map, echo=FALSE, warning=FALSE}

leaflet(ctc.bound) %>%
  setView(lng = -79.45, lat = 43.84, zoom = 9) %>%
  addFullscreenControl() %>%
  addTiles() %>%
  addPolygons(weight = 2,
              color = "black",
              fill=FALSE,
              dashArray = c(10, 5),
              opacity = .4,
              options = pathOptions(clickable = FALSE)
  ) %>%
  addMarkers(data = wells.loc %>% filter(!is.na(Cl.status), Cl.cur.trnd>trnd.trsh),
             lat = ~LAT, lng= ~LONG,
             icon = icons.up,
             label = ~Name, 
             popup = ~paste0(#'<style> div.leaflet-popup-content {width:auto !important;}</style>',
               '<b>',Name,':</b> Chloride',
               '<br>ODWQS exceedance: ',case_when(Cl.status==0 ~ 'unlikely',
                                                  Cl.status==1 ~ 'somewhat likely',
                                                  Cl.status==2 ~ 'highly likely'),
               '<br>confidence: ', Cl.conf,
               '<br>current conc: ', Cl.current,' mg/L',
               '<br>projected conc: ', Cl.pred.GAM,' mg/L'),
             options = popupOptions(maxWidth = 1000)
  ) %>%
  addMarkers(data = wells.loc %>% filter(!is.na(Cl.status), Cl.cur.trnd < -trnd.trsh),
             lat = ~LAT, lng= ~LONG,
             icon = icons.dwn,
             label = ~Name, 
             popup = ~paste0(#'<style> div.leaflet-popup-content {width:auto !important;}</style>',
               '<b>',Name,':</b> Chloride',
               '<br>ODWQS exceedance: ',case_when(Cl.status==0 ~ 'unlikely',
                                                  Cl.status==1 ~ 'somewhat likely',
                                                  Cl.status==2 ~ 'highly likely'),
               '<br>confidence: ', Cl.conf,
               '<br>current conc: ', Cl.current,' mg/L',
               '<br>projected conc: ', Cl.pred.GAM,' mg/L'),
             options = popupOptions(maxWidth = 1000)
  ) 
```

<br>


### Sodium trends

`click square in upper-left corner to enable full-screen mode`

```{r Na.trnd.map, echo=FALSE, warning=FALSE}

leaflet(ctc.bound) %>%
  setView(lng = -79.45, lat = 43.84, zoom = 9) %>%
  addFullscreenControl() %>%
  addTiles() %>%
  addPolygons(weight = 2,
              color = "black",
              fill=FALSE,
              dashArray = c(10, 5),
              opacity = .4,
              options = pathOptions(clickable = FALSE)
  ) %>%
  addMarkers(data = wells.loc %>% filter(!is.na(Na.status), Na.cur.trnd>trnd.trsh),
             lat = ~LAT, lng= ~LONG,
             icon = icons.up,
             label = ~Name, 
             popup = ~paste0(#'<style> div.leaflet-popup-content {width:auto !important;}</style>',
               '<b>',Name,':</b> Chloride',
               '<br>ODWQS exceedance: ',case_when(Na.status==0 ~ 'unlikely',
                                                  Na.status==1 ~ 'somewhat likely',
                                                  Na.status==2 ~ 'highly likely'),
               '<br>confidence: ', Na.conf,
               '<br>current conc: ', Na.current,' mg/L',
               '<br>projected conc: ', Na.pred.GAM,' mg/L'),
             options = popupOptions(maxWidth = 1000)
  ) %>%
  addMarkers(data = wells.loc %>% filter(!is.na(Na.status), Na.cur.trnd < -trnd.trsh),
             lat = ~LAT, lng= ~LONG,
             icon = icons.dwn,
             label = ~Name, 
             popup = ~paste0(#'<style> div.leaflet-popup-content {width:auto !important;}</style>',
               '<b>',Name,':</b> Chloride',
               '<br>ODWQS exceedance: ',case_when(Na.status==0 ~ 'unlikely',
                                                  Na.status==1 ~ 'somewhat likely',
                                                  Na.status==2 ~ 'highly likely'),
               '<br>confidence: ', Na.conf,
               '<br>current conc: ', Na.current,' mg/L',
               '<br>projected conc: ', Na.pred.GAM,' mg/L'),
             options = popupOptions(maxWidth = 1000)
  ) 
```

<br>


### Nitrate trends

`click square in upper-left corner to enable full-screen mode`

```{r NO3.trnd.map, echo=FALSE, warning=FALSE}

leaflet(ctc.bound) %>%
  setView(lng = -79.45, lat = 43.84, zoom = 9) %>%
  addFullscreenControl() %>%
  addTiles() %>%
  addPolygons(weight = 2,
              color = "black",
              fill=FALSE,
              dashArray = c(10, 5),
              opacity = .4,
              options = pathOptions(clickable = FALSE)
  ) %>%
  addMarkers(data = wells.loc %>% filter(!is.na(NO3.status), NO3.cur.trnd>trnd.trsh),
             lat = ~LAT, lng= ~LONG,
             icon = icons.up,
             label = ~Name, 
             popup = ~paste0(#'<style> div.leaflet-popup-content {width:auto !important;}</style>',
               '<b>',Name,':</b> Chloride',
               '<br>ODWQS exceedance: ',case_when(NO3.status==0 ~ 'unlikely',
                                                  NO3.status==1 ~ 'somewhat likely',
                                                  NO3.status==2 ~ 'highly likely'),
               '<br>confidence: ', NO3.conf,
               '<br>current conc: ', NO3.current,' mg/L',
               '<br>projected conc: ', NO3.pred.GAM,' mg/L'),
             options = popupOptions(maxWidth = 1000)
  ) %>%
  addMarkers(data = wells.loc %>% filter(!is.na(NO3.status), NO3.cur.trnd < -trnd.trsh),
             lat = ~LAT, lng= ~LONG,
             icon = icons.dwn,
             label = ~Name, 
             popup = ~paste0(#'<style> div.leaflet-popup-content {width:auto !important;}</style>',
               '<b>',Name,':</b> Chloride',
               '<br>ODWQS exceedance: ',case_when(NO3.status==0 ~ 'unlikely',
                                                  NO3.status==1 ~ 'somewhat likely',
                                                  NO3.status==2 ~ 'highly likely'),
               '<br>confidence: ', NO3.conf,
               '<br>current conc: ', NO3.current,' mg/L',
               '<br>projected conc: ', NO3.pred.GAM,' mg/L'),
             options = popupOptions(maxWidth = 1000)
  ) 
```

<br>



# Acknowledgments

Hailey Ashworth and Kata Bavrlic of the Credit Valley Conservation (CVC)


# References

Credit Valley Source Protection Authority. 2023. CTC Source Protection Region Water Quality Assessment Technical Report. October 25, 2023.

[Clean Water Act, S.O. 2006, c. [22], (2006).](https://www.ontario.ca/laws/statute/06c22) 

Ministry of Environment (MOE). (2006). Technical support document for Ontario drinking water standards, objectives, and guidelines. 
